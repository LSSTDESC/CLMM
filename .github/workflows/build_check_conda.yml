name: Build and Check

on: pull_request

jobs:
  build-gcc-ubuntu:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - uses: conda-incubator/setup-miniconda@v2
    - name: Install prereq using conda
      run: |
        conda install -c conda-forge gobject-introspection pygobject fftw cmake -y
    - name: Install prereq using pip
      run: |
        $CONDA/bin/python -m pip install -r requirements.txt
    - name: Install the package
      run: |
        $CONDA/bin/python setup.py install
    - name: Install NumCosmo from conda-forge
      run: |
        conda install -c conda-forge numcosmo -y
    - name: Install cluster_toolkit from source
      run: |
        git clone https://github.com/tmcclintock/cluster_toolkit.git
        cd cluster_toolkit
        $CONDA/bin/python setup.py install
    - name: Install CCL from source
      run: |
        git clone https://github.com/LSSTDESC/CCL
        cd CCL
        $CONDA/bin/python setup.py install
    - name: Run the unit tests
      run: |
        $CONDA/bin/python -m pip install pytest pytest-cov
        $CONDA/bin/python -m pytest tests/ --ignore=cluster_toolkit/tests --cov=clmm/
      env:
        DISPLAY: test
    - name: Install Sphinx prereq
      run: |
        $CONDA/bin/python -m pip install sphinx_rtd_theme -U
    - name: Run the docs
      run: |
        make -C docs/ html
    - name: Coveralls
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $CONDA/bin/python -m pip install coveralls
        $CONDA/bin/python -m coveralls --service=github
