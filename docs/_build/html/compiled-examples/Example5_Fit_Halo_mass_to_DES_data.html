<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example 5: Using a real datasets (DES) &mdash; CLMM 1.10.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=1d24b1d9"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Model WL Profiles (different redshift inputs)" href="demo_theory_functionality_diff_z_types.html" />
    <link rel="prev" title="Example 4: Using a real dataset (HSC)" href="Example4_Fit_Halo_mass_to_HSC_data.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CLMM
          </a>
              <div class="version">
                1.10.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../source/overview.html">Rapid overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source/citing.html">Using and citing CLMM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage Demos</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="demo_mock_cluster.html">Generate mock data for a cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_dataops_functionality.html">Measure WL Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_theory_functionality.html">Model WL Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_mock_ensemble.html">Generate mock data for a cluster ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_and_model_demo_DC2.html">Using the cosmoDC2 catalog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Mass Fitting Examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Example1_Fit_Halo_Mass_to_Shear_Catalog.html">Example 1: Ideal data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example1_Fit_shear_profile_with_miscentering.html">Example 1b: Impact of miscentering</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example2_Fit_Halo_Mass_to_Shear_Catalog.html">Example 2: Realistic data and wrong model</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example3_Fit_Halo_Mass_to_Shear_Catalog.html">Example 3: Account for the n(z) of sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example4_Fit_Halo_mass_to_HSC_data.html">Example 4: Using a real dataset (HSC)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example 5: Using a real datasets (DES)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="demo_theory_functionality_diff_z_types.html">Model WL Profiles (different redshift inputs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_theory_functionality_oo.html">Model WL Profiles (Object Oriented)</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_boost_factors.html">Boost factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_compute_deltasigma_weights.html">Weak lensing weights</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_mass_conversion.html">Mass conversion between different mass definitions</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_mock_ensemble_realistic.html">Generate “realistic” mock data for a cluster ensemble</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.clusterensemble.html">clmm.clusterensemble module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.constants.html">clmm.constants module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.cosmology.html">clmm.cosmology package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.ccl.html">clmm.cosmology.ccl module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.cluster_toolkit.html">clmm.cosmology.cluster_toolkit module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.numcosmo.html">clmm.cosmology.numcosmo module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.parent_class.html">clmm.cosmology.parent_class module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.dataops.html">clmm.dataops package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.galaxycluster.html">clmm.galaxycluster module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.gcdata.html">clmm.gcdata module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.redshift.html">clmm.redshift package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.redshift.distributions.html">clmm.redshift.distributions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.redshift.tools.html">clmm.redshift.tools module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.theory.html">clmm.theory package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.ccl.html">clmm.theory.ccl module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.cluster_toolkit.html">clmm.theory.cluster_toolkit module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.func_layer.html">clmm.theory.func_layer module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.generic.html">clmm.theory.generic module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.numcosmo.html">clmm.theory.numcosmo module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.parent_class.html">clmm.theory.parent_class module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.plotting.html">clmm.plotting package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.utils.html">clmm.utils package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.beta_lens.html">clmm.utils.beta_lens module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.boost.html">clmm.utils.boost module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.ellipticity.html">clmm.utils.ellipticity module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.statistic.html">clmm.utils.statistic module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.units.html">clmm.utils.units module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.validation.html">clmm.utils.validation module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.support.html">clmm.support package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.support.mock_data.html">clmm.support.mock_data module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.support.sampler.html">clmm.support.sampler module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CLMM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Example 5: Using a real datasets (DES)</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/compiled-examples/Example5_Fit_Halo_mass_to_DES_data.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="example-5-using-a-real-datasets-des">
<h1>Example 5: Using a real datasets (DES)<a class="headerlink" href="#example-5-using-a-real-datasets-des" title="Link to this heading"></a></h1>
<p><em>Note: this notebook was produced using a previous version of CLMM (v1.5.1)</em></p>
<section id="fit-halo-mass-to-shear-profile-using-des-data">
<h2>Fit halo mass to shear profile using DES data<a class="headerlink" href="#fit-halo-mass-to-shear-profile-using-des-data" title="Link to this heading"></a></h2>
<p><em>the LSST-DESC CLMM team</em></p>
<p>This notebook can be run on NERSC.</p>
<p>Here we demonstrate how to run CLMM on real observational datasets. As
an example, we use the data from the Dark Energy Survey (DES) public
releases. The catalogs can be accessed from the NOIRLab Astro Data Lab.</p>
<p>The steps in this notebook includes: - <a class="reference external" href="#Setup">Setting things up</a> -
<a class="reference external" href="#Selecting_a_cluster">Selecting a cluster</a> - <a class="reference external" href="#Downloading_the_catalog">Downloading the
published catalog at the cluster field</a> -
<a class="reference external" href="#Loading_the_catalog">Loading the catalog into CLMM</a> - <a class="reference external" href="#Running_CLMM">Running CLMM
on the dataset</a></p>
<p>Acknowledgement</p>
<p>DES data: <a class="reference external" href="https://des.ncsa.illinois.edu/thanks">https://des.ncsa.illinois.edu/thanks</a></p>
<p>Astro Data Lab: <a class="reference external" href="https://datalab.noirlab.edu/acknowledgements.php">https://datalab.noirlab.edu/acknowledgements.php</a></p>
</section>
<section id="setup">
<h2>1. Setup<a class="headerlink" href="#setup" title="Link to this heading"></a></h2>
<p>We import packages.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">pickle</span> <span class="k">as</span> <span class="nn">pkl</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</pre></div>
</div>
</section>
<section id="selecting-a-cluster">
<h2>2. Selecting a cluster<a class="headerlink" href="#selecting-a-cluster" title="Link to this heading"></a></h2>
<p>We use the DES Y1 redMaPPer Catalogs
(<a class="reference external" href="https://des.ncsa.illinois.edu/releases/y1a1/key-catalogs/key-redmapper">https://des.ncsa.illinois.edu/releases/y1a1/key-catalogs/key-redmapper</a>)
to select a list of high-richness (LAMBDA) galaxy clusters, which likely
have high masses.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>RA (deg)</p></th>
<th class="head"><p>DEC (deg)</p></th>
<th class="head"><p>Z_LAMBDA</p></th>
<th class="head"><p>LAMBDA</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>RMJ025415.5
585710.7</p></td>
<td><p>43.564574</p></td>
<td><p>-58.95297</p></td>
<td><p>0.429804</p></td>
<td><p>234.50368</p></td>
</tr>
<tr class="row-odd"><td><p>RMJ051637.4
543001.6</p></td>
<td><p>79.155704</p></td>
<td><p>-54.500456</p></td>
<td><p>0.30416065</p></td>
<td><p>195.06956</p></td>
</tr>
<tr class="row-even"><td><p>RMJ224851.8
443106.3</p></td>
<td><p>342.215897</p></td>
<td><p>-44.518403</p></td>
<td><p>0.3514858</p></td>
<td><p>178.83827</p></td>
</tr>
</tbody>
</table>
</section>
<section id="downloading-the-catalog-at-the-cluster-field">
<h2>3. Downloading the catalog at the cluster field<a class="headerlink" href="#downloading-the-catalog-at-the-cluster-field" title="Link to this heading"></a></h2>
<p>We consider RMJ051637.4-543001.6 (ACO S520) as an example. We can access
the DES catalog from NOIRLab Data Lab
(<a class="reference external" href="https://datalab.noirlab.edu/query.php?name=des_dr1.shape_metacal_riz_unblind">https://datalab.noirlab.edu/query.php?name=des_dr1.shape_metacal_riz_unblind</a>).
No registration is required. We make the query and download the catalogs
in “Query Interface”. We use <code class="docutils literal notranslate"><span class="pre">coadd_objects_id</span></code> to cross match the
shape catalog and photo-z catalog
(<a class="reference external" href="https://datalab.noirlab.edu/query.php?name=des_dr1.photo_z">https://datalab.noirlab.edu/query.php?name=des_dr1.photo_z</a>). Since the
cluster is at redshift about 0.3, a radius of 0.3 deg would be about a
radial distance of 5 Mpc. The final catalog includes shape info and
photo-z. Here is an example of the query SQL command. The query could
take a few minutes and the size of the catalog is about 1.4 MB (.csv).</p>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">P</span><span class="o">.</span><span class="n">mean_z</span><span class="p">,</span>
<span class="n">C</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">e1</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">e2</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">r11</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">r12</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">r21</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">r22</span>
<span class="n">FROM</span> <span class="n">des_dr1</span><span class="o">.</span><span class="n">photo_z</span> <span class="k">as</span> <span class="n">P</span>
<span class="n">INNER</span> <span class="n">JOIN</span> <span class="n">des_dr1</span><span class="o">.</span><span class="n">shape_metacal_riz_unblind</span> <span class="k">as</span> <span class="n">C</span>
<span class="n">ON</span> <span class="n">P</span><span class="o">.</span><span class="n">coadd_objects_id</span><span class="o">=</span><span class="n">C</span><span class="o">.</span><span class="n">coadd_objects_id</span>
<span class="n">WHERE</span> <span class="s1">&#39;t&#39;</span> <span class="o">=</span> <span class="n">Q3C_RADIAL_QUERY</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span><span class="mf">79.155704</span><span class="p">,</span> <span class="o">-</span><span class="mf">54.500456</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span>
<span class="n">AND</span> <span class="n">P</span><span class="o">.</span><span class="n">minchi2</span><span class="o">&lt;</span><span class="mi">1</span>
<span class="n">AND</span> <span class="n">P</span><span class="o">.</span><span class="n">z_sigma</span><span class="o">&lt;</span><span class="mf">0.1</span>
<span class="n">AND</span> <span class="n">C</span><span class="o">.</span><span class="n">flags_select</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="loading-the-catalog-into-clmm">
<h2>4. Loading the catalog into CLMM<a class="headerlink" href="#loading-the-catalog-into-clmm" title="Link to this heading"></a></h2>
<p>Once we have the catalog, we read in the catalog, make cuts on the
catalog, and adjust column names to prepare for the analysis in CLMM.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="c1"># Assume the downloaded catalog is at this path:</span>
<span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;ACOS520_DES.csv&quot;</span>
<span class="n">catalog</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">,</span> <span class="s1">&#39;.pkl&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
    <span class="n">data_0</span> <span class="o">=</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;ascii.csv&quot;</span><span class="p">)</span>
    <span class="n">pkl</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data_0</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span><span class="s2">&quot;wb&quot;</span><span class="p">))</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">data_0</span> <span class="o">=</span> <span class="n">pkl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span><span class="s2">&quot;rb&quot;</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mf">6.43</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mi">949</span> <span class="n">µs</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mf">7.38</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mf">62.1</span> <span class="n">ms</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data_0</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;mean_z&#39;</span><span class="p">,</span> <span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;e1&#39;</span><span class="p">,</span> <span class="s1">&#39;e2&#39;</span><span class="p">,</span> <span class="s1">&#39;r11&#39;</span><span class="p">,</span> <span class="s1">&#39;r12&#39;</span><span class="p">,</span> <span class="s1">&#39;r21&#39;</span><span class="p">,</span> <span class="s1">&#39;r22&#39;</span><span class="p">]</span>
</pre></div>
</div>
<section id="shear-response">
<h3>Shear response<a class="headerlink" href="#shear-response" title="Link to this heading"></a></h3>
<p>Shears in the DES data have been measured using the <code class="docutils literal notranslate"><span class="pre">metacal</span></code> method
and the catalog provides the shear response terms
(<span class="math notranslate nohighlight">\(r11,r22, r12, r21\)</span>) required to calibrate the shear values.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_0</span><span class="p">[</span><span class="s1">&#39;r11&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_0</span><span class="p">[</span><span class="s1">&#39;r22&#39;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_0</span><span class="p">[</span><span class="s1">&#39;r12&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_0</span><span class="p">[</span><span class="s1">&#39;r21&#39;</span><span class="p">]))</span>
<span class="n">r_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_0</span><span class="p">[</span><span class="s1">&#39;r11&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_0</span><span class="p">[</span><span class="s1">&#39;r22&#39;</span><span class="p">])])</span>
<span class="n">r_off_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_0</span><span class="p">[</span><span class="s1">&#39;r12&#39;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data_0</span><span class="p">[</span><span class="s1">&#39;r21&#39;</span><span class="p">])])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">r_diag</span><span class="p">,</span> <span class="n">r_off_diag</span><span class="p">,</span> <span class="n">r_off_diag</span><span class="o">/</span><span class="n">r_diag</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="mf">0.7105854684953065</span> <span class="mf">0.7070498820143473</span>
<span class="o">-</span><span class="mf">0.017056656529555746</span> <span class="mf">0.008455599747631376</span>
<span class="mf">0.7088176752548269</span> <span class="o">-</span><span class="mf">0.004300528390962185</span> <span class="o">-</span><span class="mf">0.006067185598068083</span>
</pre></div>
</div>
<p>The diagonal terms are close to each other. The off-diagonal terms are
much smaller (&lt;1%). We use the mean of the diagonal terms to reduce
noise. We also skip the selection bias since it is typically at percent
level.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Adjust column names.</span>
<span class="k">def</span> <span class="nf">adjust_column_names</span><span class="p">(</span><span class="n">catalog_in</span><span class="p">):</span>
    <span class="c1"># We consider a map between new and old column names.</span>
    <span class="c1"># Note we have considered shear calibration here.</span>
    <span class="n">column_name_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;ra&quot;</span><span class="p">:</span> <span class="s2">&quot;ra&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dec&quot;</span><span class="p">:</span> <span class="s2">&quot;dec&quot;</span><span class="p">,</span>
        <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="s2">&quot;mean_z&quot;</span><span class="p">,</span>
        <span class="s2">&quot;e1&quot;</span><span class="p">:</span> <span class="s2">&quot;e1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;e2&quot;</span><span class="p">:</span> <span class="s2">&quot;e2&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">catalog_out</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">column_name_map</span><span class="p">:</span>
        <span class="n">catalog_out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">catalog_in</span><span class="p">[</span><span class="n">column_name_map</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>

    <span class="n">catalog_out</span><span class="p">[</span><span class="s2">&quot;e1&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">r_diag</span>
    <span class="n">catalog_out</span><span class="p">[</span><span class="s2">&quot;e2&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">r_diag</span>

    <span class="k">return</span> <span class="n">catalog_out</span>

<span class="n">obs_galaxies</span> <span class="o">=</span> <span class="n">adjust_column_names</span><span class="p">(</span><span class="n">data_0</span><span class="p">)</span>

<span class="n">select</span> <span class="o">=</span> <span class="p">(</span><span class="n">obs_galaxies</span><span class="p">[</span><span class="s2">&quot;e1&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">obs_galaxies</span><span class="p">[</span><span class="s2">&quot;e2&quot;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;=</span><span class="mf">1.</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">select</span><span class="p">)</span> <span class="p">)</span>
<span class="n">obs_galaxies</span> <span class="o">=</span> <span class="n">obs_galaxies</span><span class="p">[</span><span class="n">select</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="mi">0</span>
</pre></div>
</div>
</section>
<section id="basic-visualization">
<h3>Basic visualization<a class="headerlink" href="#basic-visualization" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_plots</span><span class="p">(</span><span class="n">catalog_in</span><span class="p">):</span>
    <span class="c1"># Scatter plot</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">catalog_in</span><span class="p">[</span><span class="s2">&quot;ra&quot;</span><span class="p">],</span> <span class="n">catalog_in</span><span class="p">[</span><span class="s2">&quot;dec&quot;</span><span class="p">],</span>
                <span class="n">c</span><span class="o">=</span><span class="n">catalog_in</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;ra&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;dec&quot;</span><span class="p">)</span>
    <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">)</span>

    <span class="c1"># Histogram</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">catalog_in</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">)</span>

    <span class="c1"># Relation</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">catalog_in</span><span class="p">[</span><span class="s2">&quot;e1&quot;</span><span class="p">],</span> <span class="n">catalog_in</span><span class="p">[</span><span class="s2">&quot;e2&quot;</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;e1&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;e2&quot;</span><span class="p">)</span>

<span class="n">make_plots</span><span class="p">(</span><span class="n">obs_galaxies</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/Example5_Fit_Halo_mass_to_DES_data_13_0.png" src="../_images/Example5_Fit_Halo_mass_to_DES_data_13_0.png" />
<img alt="../_images/Example5_Fit_Halo_mass_to_DES_data_13_1.png" src="../_images/Example5_Fit_Halo_mass_to_DES_data_13_1.png" />
<img alt="../_images/Example5_Fit_Halo_mass_to_DES_data_13_2.png" src="../_images/Example5_Fit_Halo_mass_to_DES_data_13_2.png" />
</section>
</section>
<section id="running-clmm-on-the-dataset-we-use-the-functions-similar-to-examples-paper-v1-0-gt-and-use-case-ipynb">
<h2>5. Running CLMM on the dataset We use the functions similar to examples/Paper_v1.0/gt_and_use_case.ipynb<a class="headerlink" href="#running-clmm-on-the-dataset-we-use-the-functions-similar-to-examples-paper-v1-0-gt-and-use-case-ipynb" title="Link to this heading"></a></h2>
<section id="make-a-galaxy-cluster-object">
<h3>Make a galaxy cluster object<a class="headerlink" href="#make-a-galaxy-cluster-object" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">clmm</span> <span class="kn">import</span> <span class="n">Cosmology</span>
<span class="kn">import</span> <span class="nn">clmm</span>

<span class="n">cosmo</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="p">(</span><span class="n">H0</span><span class="o">=</span><span class="mf">70.0</span><span class="p">,</span> <span class="n">Omega_dm0</span><span class="o">=</span><span class="mf">0.27</span><span class="o">-</span><span class="mf">0.045</span><span class="p">,</span> <span class="n">Omega_b0</span><span class="o">=</span><span class="mf">0.045</span><span class="p">,</span> <span class="n">Omega_k0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

<span class="c1"># We consider RMJ051637.4-543001.6 (ACO S520)</span>
<span class="n">cluster_z</span> <span class="o">=</span> <span class="mf">0.30416065</span> <span class="c1"># Cluster redshift</span>
<span class="n">cluster_ra</span> <span class="o">=</span> <span class="mf">79.155704</span> <span class="c1"># Cluster Ra in deg</span>
<span class="n">cluster_dec</span> <span class="o">=</span> <span class="o">-</span><span class="mf">54.500456</span> <span class="c1"># Cluster Dec in deg</span>

<span class="c1"># Select background galaxies</span>
<span class="n">obs_galaxies</span> <span class="o">=</span> <span class="n">obs_galaxies</span><span class="p">[(</span><span class="n">obs_galaxies</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span><span class="n">cluster_z</span><span class="o">+</span><span class="mf">0.1</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="n">obs_galaxies</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="mf">1.5</span><span class="p">)]</span>

<span class="n">obs_galaxies</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">obs_galaxies</span><span class="p">))</span>

<span class="c1"># Put galaxy values on arrays</span>
<span class="n">gal_ra</span> <span class="o">=</span> <span class="n">obs_galaxies</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="c1"># Galaxies Ra in deg</span>
<span class="n">gal_dec</span> <span class="o">=</span> <span class="n">obs_galaxies</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="c1"># Galaxies Dec in deg</span>
<span class="n">gal_e1</span> <span class="o">=</span> <span class="n">obs_galaxies</span><span class="p">[</span><span class="s1">&#39;e1&#39;</span><span class="p">]</span> <span class="c1"># Galaxies elipticipy 1</span>
<span class="n">gal_e2</span> <span class="o">=</span> <span class="n">obs_galaxies</span><span class="p">[</span><span class="s1">&#39;e2&#39;</span><span class="p">]</span> <span class="c1"># Galaxies elipticipy 2</span>
<span class="n">gal_z</span> <span class="o">=</span> <span class="n">obs_galaxies</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span> <span class="c1"># Galaxies observed redshift</span>
<span class="n">gal_id</span> <span class="o">=</span> <span class="n">obs_galaxies</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="c1"># Galaxies ID</span>

<span class="c1"># Create a GCData with the galaxies.</span>
<span class="n">galaxies</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">GCData</span><span class="p">([</span><span class="n">gal_ra</span><span class="p">,</span> <span class="n">gal_dec</span><span class="p">,</span> <span class="n">gal_e1</span><span class="p">,</span> <span class="n">gal_e2</span><span class="p">,</span> <span class="n">gal_z</span><span class="p">,</span> <span class="n">gal_id</span><span class="p">],</span>
                        <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;e1&#39;</span><span class="p">,</span> <span class="s1">&#39;e2&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">])</span>

<span class="c1"># Create a GalaxyCluster.</span>
<span class="n">cluster</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">GalaxyCluster</span><span class="p">(</span><span class="s2">&quot;Name of cluster&quot;</span><span class="p">,</span> <span class="n">cluster_ra</span><span class="p">,</span> <span class="n">cluster_dec</span><span class="p">,</span>
                             <span class="n">cluster_z</span><span class="p">,</span> <span class="n">galaxies</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="measure-the-shear-profile">
<h3>Measure the shear profile<a class="headerlink" href="#measure-the-shear-profile" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">clmm.dataops</span> <span class="k">as</span> <span class="nn">da</span>

<span class="c1"># Convert ellipticities into shears for the members.</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">compute_tangential_and_cross_components</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">galcat</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>

<span class="c1"># Measure profile and add profile table to the cluster.</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">make_radial_profile</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">da</span><span class="o">.</span><span class="n">make_bins</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;evenlog10width&#39;</span><span class="p">),</span>
                            <span class="n">bin_units</span><span class="o">=</span><span class="s2">&quot;Mpc&quot;</span><span class="p">,</span>
                            <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">,</span>
                            <span class="n">include_empty_bins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">gal_ids_in_bins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="o">.</span><span class="n">colnames</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="s1">&#39;e1&#39;</span><span class="p">,</span> <span class="s1">&#39;e2&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;et&#39;</span><span class="p">,</span> <span class="s1">&#39;ex&#39;</span><span class="p">]</span>
<span class="p">[</span><span class="s1">&#39;radius_min&#39;</span><span class="p">,</span> <span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="s1">&#39;radius_max&#39;</span><span class="p">,</span> <span class="s1">&#39;gt&#39;</span><span class="p">,</span> <span class="s1">&#39;gt_err&#39;</span><span class="p">,</span> <span class="s1">&#39;gx&#39;</span><span class="p">,</span> <span class="s1">&#39;gx_err&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;z_err&#39;</span><span class="p">,</span> <span class="s1">&#39;n_src&#39;</span><span class="p">,</span> <span class="s1">&#39;gal_id&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">errorbar_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
                       <span class="n">markersize</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span> <span class="n">capthick</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span>
            <span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">errorbar_kwargs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;R [Mpc]&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$g_t$&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/Example5_Fit_Halo_mass_to_DES_data_19_0.png" src="../_images/Example5_Fit_Halo_mass_to_DES_data_19_0.png" />
</section>
<section id="theoretical-predictions">
<h3>Theoretical predictions<a class="headerlink" href="#theoretical-predictions" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">clmm.utils</span> <span class="kn">import</span> <span class="n">convert_units</span>

<span class="c1"># Model relying on the overall redshift distribution of the sources (WtG III Applegate et al. 2014).</span>
<span class="n">z_inf</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">concentration</span> <span class="o">=</span> <span class="mf">4.</span>

<span class="n">bs_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">clmm</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">compute_beta_s</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">z_inf</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">))</span>
<span class="n">bs2_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">clmm</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">compute_beta_s</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">],</span> <span class="n">cluster_z</span><span class="p">,</span> <span class="n">z_inf</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">predict_reduced_tangential_shear_redshift_distribution</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">logm</span><span class="p">):</span>

    <span class="n">gt</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">compute_reduced_tangential_shear</span><span class="p">(</span>
        <span class="n">r_proj</span><span class="o">=</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="c1"># Radial component of the profile</span>
        <span class="n">mdelta</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="n">logm</span><span class="p">,</span> <span class="c1"># Mass of the cluster [M_sun]</span>
        <span class="n">cdelta</span><span class="o">=</span><span class="n">concentration</span><span class="p">,</span> <span class="c1"># Concentration of the cluster</span>
        <span class="n">z_cluster</span><span class="o">=</span><span class="n">cluster_z</span><span class="p">,</span> <span class="c1"># Redshift of the cluster</span>
        <span class="n">z_source</span><span class="o">=</span><span class="p">(</span><span class="n">bs_mean</span><span class="p">,</span> <span class="n">bs2_mean</span><span class="p">),</span> <span class="c1"># tuple of (bs_mean, bs2_mean)</span>
        <span class="n">z_src_info</span><span class="o">=</span><span class="s1">&#39;beta&#39;</span><span class="p">,</span>
        <span class="n">approx</span><span class="o">=</span><span class="s1">&#39;order1&#39;</span><span class="p">,</span>
        <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">,</span>
        <span class="n">delta_mdef</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
        <span class="n">massdef</span><span class="o">=</span><span class="s1">&#39;critical&#39;</span><span class="p">,</span>
        <span class="n">halo_profile_model</span><span class="o">=</span><span class="s1">&#39;nfw&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">gt</span>


<span class="c1"># Model using individual redshift and radial information, to compute the averaged shear in each radial bin, based on the galaxies actually present in that bin.</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;theta_mpc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">convert_units</span><span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">],</span> <span class="s1">&#39;radians&#39;</span><span class="p">,</span> <span class="s1">&#39;mpc&#39;</span><span class="p">,</span> <span class="n">cluster</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">cosmo</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">predict_reduced_tangential_shear_individual_redshift</span><span class="p">(</span><span class="n">profile</span><span class="p">,</span> <span class="n">logm</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
        <span class="n">clmm</span><span class="o">.</span><span class="n">compute_reduced_tangential_shear</span><span class="p">(</span>
            <span class="c1"># Radial component of each source galaxy inside the radial bin</span>
            <span class="n">r_proj</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="n">radial_bin</span><span class="p">[</span><span class="s1">&#39;gal_id&#39;</span><span class="p">]][</span><span class="s1">&#39;theta_mpc&#39;</span><span class="p">],</span>
            <span class="n">mdelta</span><span class="o">=</span><span class="mi">10</span><span class="o">**</span><span class="n">logm</span><span class="p">,</span> <span class="c1"># Mass of the cluster [M_sun]</span>
            <span class="n">cdelta</span><span class="o">=</span><span class="n">concentration</span><span class="p">,</span> <span class="c1"># Concentration of the cluster</span>
            <span class="n">z_cluster</span><span class="o">=</span><span class="n">cluster_z</span><span class="p">,</span> <span class="c1"># Redshift of the cluster</span>
            <span class="c1"># Redshift value of each source galaxy inside the radial bin</span>
            <span class="n">z_source</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">galcat</span><span class="p">[</span><span class="n">radial_bin</span><span class="p">[</span><span class="s1">&#39;gal_id&#39;</span><span class="p">]][</span><span class="s1">&#39;z&#39;</span><span class="p">],</span>
            <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo</span><span class="p">,</span>
            <span class="n">delta_mdef</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
            <span class="n">massdef</span><span class="o">=</span><span class="s1">&#39;critical&#39;</span><span class="p">,</span>
            <span class="n">halo_profile_model</span><span class="o">=</span><span class="s1">&#39;nfw&#39;</span>
        <span class="p">))</span> <span class="k">for</span> <span class="n">radial_bin</span> <span class="ow">in</span> <span class="n">profile</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="mass-fitting">
<h3>Mass fitting<a class="headerlink" href="#mass-fitting" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mask_for_fit</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;n_src&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span>
<span class="n">data_for_fit</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="n">mask_for_fit</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">clmm.support.sampler</span> <span class="kn">import</span> <span class="n">fitters</span>
<span class="k">def</span> <span class="nf">fit_mass</span><span class="p">(</span><span class="n">predict_function</span><span class="p">):</span>
    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">fitters</span><span class="p">[</span><span class="s1">&#39;curve_fit&#39;</span><span class="p">](</span>
        <span class="n">predict_function</span><span class="p">,</span>
        <span class="n">data_for_fit</span><span class="p">,</span>
        <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span>
        <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[</span><span class="mf">10.</span><span class="p">,</span><span class="mf">17.</span><span class="p">])</span>
    <span class="n">logm</span><span class="p">,</span> <span class="n">logm_err</span> <span class="o">=</span> <span class="n">popt</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pcov</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;logm&#39;</span><span class="p">:</span><span class="n">logm</span><span class="p">,</span> <span class="s1">&#39;logm_err&#39;</span><span class="p">:</span><span class="n">logm_err</span><span class="p">,</span>
            <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="o">**</span><span class="n">logm</span><span class="p">,</span> <span class="s1">&#39;m_err&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">logm</span><span class="p">)</span><span class="o">*</span><span class="n">logm_err</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">10</span><span class="p">)}</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">fit_redshift_distribution</span> <span class="o">=</span> <span class="n">fit_mass</span><span class="p">(</span><span class="n">predict_reduced_tangential_shear_redshift_distribution</span><span class="p">)</span>
<span class="n">fit_individual_redshift</span> <span class="o">=</span> <span class="n">fit_mass</span><span class="p">(</span><span class="n">predict_reduced_tangential_shear_individual_redshift</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mi">654</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mi">0</span> <span class="n">ns</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mi">654</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mi">652</span> <span class="n">ms</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Best fit mass for N(z) model                     =&#39;</span>
      <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">fit_redshift_distribution</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1"> +/- </span><span class="si">{</span><span class="n">fit_redshift_distribution</span><span class="p">[</span><span class="s2">&quot;m_err&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1"> Msun&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Best fit mass for individual redshift and radius =&#39;</span>
      <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">fit_individual_redshift</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1"> +/- </span><span class="si">{</span><span class="n">fit_individual_redshift</span><span class="p">[</span><span class="s2">&quot;m_err&quot;</span><span class="p">]</span><span class="si">:</span><span class="s1">.3e</span><span class="si">}</span><span class="s1"> Msun&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">Best</span> <span class="n">fit</span> <span class="n">mass</span> <span class="k">for</span> <span class="n">N</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="n">model</span>                     <span class="o">=</span> <span class="mf">3.210e+14</span> <span class="o">+/-</span> <span class="mf">1.129e+14</span> <span class="n">Msun</span>
<span class="n">Best</span> <span class="n">fit</span> <span class="n">mass</span> <span class="k">for</span> <span class="n">individual</span> <span class="n">redshift</span> <span class="ow">and</span> <span class="n">radius</span> <span class="o">=</span> <span class="mf">5.172e+14</span> <span class="o">+/-</span> <span class="mf">1.716e+14</span> <span class="n">Msun</span>
</pre></div>
</div>
</section>
<section id="visualization-of-the-results">
<h3>Visualization of the results<a class="headerlink" href="#visualization-of-the-results" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_predicted_shear</span><span class="p">(</span><span class="n">predict_function</span><span class="p">,</span> <span class="n">fit_values</span><span class="p">):</span>
    <span class="n">gt_est</span> <span class="o">=</span> <span class="n">predict_function</span><span class="p">(</span><span class="n">data_for_fit</span><span class="p">,</span> <span class="n">fit_values</span><span class="p">[</span><span class="s1">&#39;logm&#39;</span><span class="p">])</span>
    <span class="n">gt_est_err</span> <span class="o">=</span> <span class="p">[</span><span class="n">predict_function</span><span class="p">(</span><span class="n">data_for_fit</span><span class="p">,</span> <span class="n">fit_values</span><span class="p">[</span><span class="s1">&#39;logm&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">fit_values</span><span class="p">[</span><span class="s1">&#39;logm_err&#39;</span><span class="p">])</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">gt_est</span><span class="p">,</span> <span class="n">gt_est_err</span>

<span class="n">gt_redshift_distribution</span><span class="p">,</span> <span class="n">gt_err_redshift_distribution</span> <span class="o">=</span>  <span class="n">get_predicted_shear</span><span class="p">(</span>
    <span class="n">predict_reduced_tangential_shear_redshift_distribution</span><span class="p">,</span> <span class="n">fit_redshift_distribution</span><span class="p">)</span>
<span class="n">gt_individual_redshift</span><span class="p">,</span> <span class="n">gt_err_individual_redshift</span> <span class="o">=</span>  <span class="n">get_predicted_shear</span><span class="p">(</span>
    <span class="n">predict_reduced_tangential_shear_individual_redshift</span><span class="p">,</span> <span class="n">fit_individual_redshift</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">chi2_redshift_distribution_dof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
    <span class="p">(</span><span class="n">gt_redshift_distribution</span><span class="o">-</span><span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_for_fit</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">chi2_individual_redshift_dof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
    <span class="p">(</span><span class="n">gt_individual_redshift</span><span class="o">-</span><span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_for_fit</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reduced chi2 (N(z) model) = </span><span class="si">{</span><span class="n">chi2_redshift_distribution_dof</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Reduced chi2 (individual (R,z) model) = </span><span class="si">{</span><span class="n">chi2_individual_redshift_dof</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">Reduced</span> <span class="n">chi2</span> <span class="p">(</span><span class="n">N</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="n">model</span><span class="p">)</span> <span class="o">=</span> <span class="mf">4.780165089363789</span>
<span class="n">Reduced</span> <span class="n">chi2</span> <span class="p">(</span><span class="n">individual</span> <span class="p">(</span><span class="n">R</span><span class="p">,</span><span class="n">z</span><span class="p">)</span> <span class="n">model</span><span class="p">)</span> <span class="o">=</span> <span class="mf">4.411023500984547</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span>
                       <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span><span class="s1">&#39;wspace&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span><span class="s1">&#39;hspace&#39;</span><span class="p">:</span> <span class="mf">0.03</span><span class="p">});</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span><span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">],</span> <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">errorbar_kwargs</span><span class="p">)</span>

<span class="c1"># Points in grey have not been used for the fit.</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">mask_for_fit</span><span class="p">],</span> <span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">mask_for_fit</span><span class="p">],</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">][</span><span class="o">~</span><span class="n">mask_for_fit</span><span class="p">],</span>
    <span class="n">c</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">errorbar_kwargs</span><span class="p">)</span>

<span class="n">pow10</span> <span class="o">=</span> <span class="mi">14</span>
<span class="n">mlabel</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">name</span><span class="p">,</span> <span class="n">fits</span><span class="p">:</span> <span class="p">(</span>
    <span class="sa">fr</span><span class="s1">&#39;$M_</span><span class="se">{{</span><span class="s1">fit</span><span class="se">}}</span><span class="s1">^</span><span class="se">{{</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="se">}}</span><span class="s1"> = &#39;</span>
    <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;m&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="n">pow10</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">\pm&#39;</span>
    <span class="sa">fr</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fits</span><span class="p">[</span><span class="s2">&quot;m_err&quot;</span><span class="p">]</span><span class="o">/</span><span class="mi">10</span><span class="o">**</span><span class="n">pow10</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="sa">fr</span><span class="s1">&#39;\times 10^</span><span class="se">{{</span><span class="si">{</span><span class="n">pow10</span><span class="si">}</span><span class="se">}}</span><span class="s1"> M_\odot$&#39;</span><span class="p">)</span>

<span class="c1"># The model for the 1st method.</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span>
    <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">gt_redshift_distribution</span><span class="p">,</span><span class="s1">&#39;-C1&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="n">mlabel</span><span class="p">(</span><span class="s1">&#39;N(z)&#39;</span><span class="p">,</span> <span class="n">fit_redshift_distribution</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="o">*</span><span class="n">gt_err_redshift_distribution</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>

<span class="c1"># The model for the 2nd method.</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span>
    <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">gt_individual_redshift</span><span class="p">,</span><span class="s1">&#39;-C2&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="n">mlabel</span><span class="p">(</span><span class="s1">&#39;z,R&#39;</span><span class="p">,</span> <span class="n">fit_individual_redshift</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
    <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="o">*</span><span class="n">gt_err_individual_redshift</span><span class="p">,</span>
    <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.2</span><span class="p">)</span>


<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$g_t$&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mf">1.e-3</span><span class="p">,</span><span class="mf">0.5</span><span class="p">)</span>


<span class="n">errorbar_kwargs2</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span><span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">errorbar_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="s1">&#39;marker&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">k</span><span class="p">}</span>
<span class="n">errorbar_kwargs2</span><span class="p">[</span><span class="s1">&#39;markersize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">errorbar_kwargs2</span><span class="p">[</span><span class="s1">&#39;markeredgewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">.5</span>

<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mf">.15</span>


<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">],</span> <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">gt_redshift_distribution</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">yerr</span><span class="o">=</span><span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">gt_redshift_distribution</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">errorbar_kwargs2</span><span class="p">)</span>
<span class="n">errorbar_kwargs2</span><span class="p">[</span><span class="s1">&#39;markersize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">errorbar_kwargs2</span><span class="p">[</span><span class="s1">&#39;markeredgewidth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">.5</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">delta</span><span class="p">,</span> <span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">gt_individual_redshift</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">yerr</span><span class="o">=</span><span class="n">data_for_fit</span><span class="p">[</span><span class="s1">&#39;gt_err&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">gt_individual_redshift</span><span class="p">,</span>
    <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">errorbar_kwargs2</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$R$ [Mpc]&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$g_t^</span><span class="si">{data}</span><span class="s1">/g_t^{mod.}-1$&#39;</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mf">.3</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Note since we made cuts on the catalog, the redshift distribution of the remaining sources might not be representative.</span>
</pre></div>
</div>
<img alt="../_images/Example5_Fit_Halo_mass_to_DES_data_29_0.png" src="../_images/Example5_Fit_Halo_mass_to_DES_data_29_0.png" />
</section>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading"></a></h2>
<p>Zuntz J., Sheldon E., Samuroff S., Troxel M. A., Jarvis M., MacCrann N.,
Gruen D., et al., 2018, MNRAS, 481, 1149.
<a class="reference external" href="http://adsabs.harvard.edu/cgi-bin/bib_query?arXiv:1708.01533">doi:10.1093/mnras/sty2219</a></p>
<p>Hoyle B., Gruen D., Bernstein G. M., Rau M. M., De Vicente J., Hartley
W. G., Gaztanaga E., et al., 2018, MNRAS, 478, 592.
<a class="reference external" href="http://adsabs.harvard.edu/abs/2018MNRAS.478..592H">doi:10.1093/mnras/sty957</a></p>
<p>McClintock T., Varga T. N., Gruen D., Rozo E., Rykoff E. S., Shin T.,
Melchior P., et al., 2019, MNRAS, 482, 1352.
<a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2019MNRAS.482.1352M/abstract">doi:10.1093/mnras/sty2711</a></p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2021, LSST DESC CLMM Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>