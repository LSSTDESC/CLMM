<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Generate “realistic” mock data for a cluster ensemble &mdash; CLMM 1.12.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=fe8e256b"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Documentation" href="../api.html" />
    <link rel="prev" title="Mass conversion between different mass definitions" href="demo_mass_conversion.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            CLMM
          </a>
              <div class="version">
                1.12.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Getting Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../source/overview.html">Rapid overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../source/citing.html">Using and citing CLMM</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage Demos</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="demo_mock_cluster.html">Generate mock data for a cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_dataops_functionality.html">Measure WL Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_theory_functionality.html">Model WL Profiles</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_mock_ensemble.html">Generate mock data for a cluster ensemble</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_and_model_demo_DC2.html">Using the cosmoDC2 catalog</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Mass Fitting Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Example1_Fit_Halo_Mass_to_Shear_Catalog.html">Example 1: Ideal data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example1_Fit_shear_profile_with_miscentering.html">Example 1b: Impact of miscentering</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example2_Fit_Halo_Mass_to_Shear_Catalog.html">Example 2: Realistic data and wrong model</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example3_Fit_Halo_Mass_to_Shear_Catalog.html">Example 3: Account for the n(z) of sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example4_Fit_Halo_mass_to_HSC_data.html">Example 4: Using a real dataset (HSC)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Example5_Fit_Halo_mass_to_DES_data.html">Example 5: Using a real datasets (DES)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="demo_theory_functionality_diff_z_types.html">Model WL Profiles (different redshift inputs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_theory_functionality_oo.html">Model WL Profiles (Object Oriented)</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_boost_factors.html">Boost factors</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_compute_deltasigma_weights.html">Weak lensing weights</a></li>
<li class="toctree-l1"><a class="reference internal" href="demo_mass_conversion.html">Mass conversion between different mass definitions</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Generate “realistic” mock data for a cluster ensemble</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Documentation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.clusterensemble.html">clmm.clusterensemble module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.constants.html">clmm.constants module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.cosmology.html">clmm.cosmology package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.ccl.html">clmm.cosmology.ccl module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.cluster_toolkit.html">clmm.cosmology.cluster_toolkit module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.numcosmo.html">clmm.cosmology.numcosmo module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.cosmology.parent_class.html">clmm.cosmology.parent_class module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.dataops.html">clmm.dataops package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.galaxycluster.html">clmm.galaxycluster module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.gcdata.html">clmm.gcdata module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.redshift.html">clmm.redshift package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.redshift.distributions.html">clmm.redshift.distributions module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.redshift.tools.html">clmm.redshift.tools module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.theory.html">clmm.theory package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.ccl.html">clmm.theory.ccl module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.cluster_toolkit.html">clmm.theory.cluster_toolkit module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.func_layer.html">clmm.theory.func_layer module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.generic.html">clmm.theory.generic module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.numcosmo.html">clmm.theory.numcosmo module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.theory.parent_class.html">clmm.theory.parent_class module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.plotting.html">clmm.plotting package</a></li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.utils.html">clmm.utils package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.beta_lens.html">clmm.utils.beta_lens module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.boost.html">clmm.utils.boost module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.ellipticity.html">clmm.utils.ellipticity module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.statistic.html">clmm.utils.statistic module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.units.html">clmm.utils.units module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.utils.validation.html">clmm.utils.validation module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../api/clmm.support.html">clmm.support package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.support.mock_data.html">clmm.support.mock_data module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api/clmm.support.sampler.html">clmm.support.sampler module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CLMM</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Generate “realistic” mock data for a cluster ensemble</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/compiled-examples/demo_mock_ensemble_realistic.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="generate-realistic-mock-data-for-a-cluster-ensemble">
<h1>Generate “realistic” mock data for a cluster ensemble<a class="headerlink" href="#generate-realistic-mock-data-for-a-cluster-ensemble" title="Link to this heading"></a></h1>
<section id="generate-cluster-ensemble-with-realistic-mass-and-redshift-distribution">
<h2>Generate cluster ensemble with “realistic” mass and redshift distribution<a class="headerlink" href="#generate-cluster-ensemble-with-realistic-mass-and-redshift-distribution" title="Link to this heading"></a></h2>
<p>In this notebook, we generate a ‘realistic’ mock cluster ensemble,
i.e. given a halo mass function, and mass-concentration relation (more
complexity, such as miscentering, could also be added but it’s not done
here). The notebook is structured as follows: - Implementation of the
CCL and NumCosmo mass functions. - Some comparisons between the
different backends. - Implementation of a accept-reject method to
generate cluster samples from the mass function. - Generation of a
cluster catalog for mass and redshift bins followed by a comparison with
the theoretical prediction</p>
<p>Then, the remaining of the notebook repeats what was done in the
<code class="docutils literal notranslate"><span class="pre">Example_cluster_ensemble.ipynb</span></code>. - Geration of mock galaxy data for
each cluster - Creating ClusterEnsemble object and estimation of
individual excess surface density profiles - An analysis of the
covariance of the stack between radial bins</p>
</section>
<section id="draw-pairs-of-mass-and-redshift-according-to-a-mass-function-computed-with-either-ccl-or-numcosmo">
<h2>Draw pairs of mass and redshift according to a mass function (computed with either CCL or NumCosmo)<a class="headerlink" href="#draw-pairs-of-mass-and-redshift-according-to-a-mass-function-computed-with-either-ccl-or-numcosmo" title="Link to this heading"></a></h2>
<!-- The halo mass function is given by
$$
\frac{dn}{dM} = f(\sigma) \frac{\bar{\rho}_m}{M}\frac{d ln\sigma^{-1}}{dM}
$$
where $\sigma$ is the variance, $\bar{\rho}_m$ is the mean density of the universe, $M$ is the halo mass and $f$ is the multiplicity function. In this notebook we use the Tinker multiplicity function
$$
f(\sigma) = A \left[ \left(\frac{\sigma}{b}\right)^{-a} +1\right] e^{-\frac{c}{\sigma^2}}
.$$
In the above, $A$ is the normalization factor and $a,b$ and $c$ are parameters to be set by the model.  --><p>In this notebook we use the Tinker halo mass function, and demonstrate
the implementation via CCL or NumCosmo.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pyccl</span> <span class="k">as</span> <span class="nn">ccl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">clmm</span>
<span class="kn">from</span> <span class="nn">clmm</span> <span class="kn">import</span> <span class="n">GalaxyCluster</span><span class="p">,</span> <span class="n">ClusterEnsemble</span><span class="p">,</span> <span class="n">GCData</span>
<span class="kn">from</span> <span class="nn">clmm</span> <span class="kn">import</span> <span class="n">Cosmology</span>
<span class="kn">from</span> <span class="nn">clmm.support</span> <span class="kn">import</span> <span class="n">mock_data</span> <span class="k">as</span> <span class="n">mock</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># NumCosmo imports</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">gi</span>

    <span class="n">gi</span><span class="o">.</span><span class="n">require_version</span><span class="p">(</span><span class="s2">&quot;NumCosmo&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span>
    <span class="n">gi</span><span class="o">.</span><span class="n">require_version</span><span class="p">(</span><span class="s2">&quot;NumCosmoMath&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">GObject</span>
<span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">NumCosmo</span> <span class="k">as</span> <span class="n">Nc</span>
<span class="kn">from</span> <span class="nn">gi.repository</span> <span class="kn">import</span> <span class="n">NumCosmoMath</span> <span class="k">as</span> <span class="n">Ncm</span>

<span class="n">Ncm</span><span class="o">.</span><span class="n">cfg_init</span><span class="p">()</span>
<span class="n">Ncm</span><span class="o">.</span><span class="n">cfg_set_log_handler</span><span class="p">(</span><span class="k">lambda</span> <span class="n">msg</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">())</span>
</pre></div>
</div>
<p>For reproducibility:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</pre></div>
</div>
<section id="mass-function-ccl-implementation">
<h3>Mass function - CCL implementation<a class="headerlink" href="#mass-function-ccl-implementation" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cosmo</span> <span class="o">=</span> <span class="n">ccl</span><span class="o">.</span><span class="n">Cosmology</span><span class="p">(</span>
    <span class="n">Omega_c</span><span class="o">=</span><span class="mf">0.26</span><span class="p">,</span>
    <span class="n">Omega_b</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
    <span class="n">h</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
    <span class="n">sigma8</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">n_s</span><span class="o">=</span><span class="mf">0.96</span><span class="p">,</span>
    <span class="n">Neff</span><span class="o">=</span><span class="mf">3.04</span><span class="p">,</span>
    <span class="n">m_nu</span><span class="o">=</span><span class="mf">1.0e-05</span><span class="p">,</span>
    <span class="n">mass_split</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">hmd_200c</span> <span class="o">=</span> <span class="n">ccl</span><span class="o">.</span><span class="n">halos</span><span class="o">.</span><span class="n">MassDef</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;critical&quot;</span><span class="p">)</span>


<span class="c1"># For a different multiplicty function, the user must change this function below</span>
<span class="k">def</span> <span class="nf">tinker08_ccl</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="n">mass</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="p">(</span><span class="n">logm</span><span class="p">)</span>
    <span class="n">hmf_200c</span> <span class="o">=</span> <span class="n">ccl</span><span class="o">.</span><span class="n">halos</span><span class="o">.</span><span class="n">MassFuncTinker08</span><span class="p">(</span><span class="n">mass_def</span><span class="o">=</span><span class="n">hmd_200c</span><span class="p">)</span>
    <span class="n">nm</span> <span class="o">=</span> <span class="n">hmf_200c</span><span class="p">(</span><span class="n">cosmo</span><span class="p">,</span> <span class="n">mass</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">z</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">nm</span>  <span class="c1"># dn/dlog10M</span>


<span class="c1"># Computing the volume element</span>
<span class="k">def</span> <span class="nf">dV_over_dOmega_dz</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">ccl</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">angular_diameter_distance</span><span class="p">(</span><span class="n">cosmo</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">ccl</span><span class="o">.</span><span class="n">background</span><span class="o">.</span><span class="n">h_over_h0</span><span class="p">(</span><span class="n">cosmo</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">((</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">da</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">ccl</span><span class="o">.</span><span class="n">physical_constants</span><span class="o">.</span><span class="n">CLIGHT_HMPC</span> <span class="o">/</span> <span class="n">cosmo</span><span class="p">[</span><span class="s2">&quot;h&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">E</span>


<span class="k">def</span> <span class="nf">pdf_tinker08_ccl</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tinker08_ccl</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">dV_over_dOmega_dz</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="mass-function-numcosmo-implementation">
<h3>Mass function - Numcosmo implementation<a class="headerlink" href="#mass-function-numcosmo-implementation" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Ncm</span><span class="o">.</span><span class="n">cfg_init</span><span class="p">()</span>
<span class="c1"># cosmo_nc = Nc.HICosmoDEXcdm()</span>
<span class="n">cosmo_nc</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">HICosmo</span><span class="o">.</span><span class="n">new_from_name</span><span class="p">(</span><span class="n">Nc</span><span class="o">.</span><span class="n">HICosmo</span><span class="p">,</span> <span class="s2">&quot;NcHICosmoDECpl{&#39;massnu-length&#39;:&lt;1&gt;}&quot;</span><span class="p">)</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">omega_x2omega_k</span><span class="p">()</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">param_set_by_name</span><span class="p">(</span><span class="s2">&quot;w0&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">)</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">param_set_by_name</span><span class="p">(</span><span class="s2">&quot;w1&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">param_set_by_name</span><span class="p">(</span><span class="s2">&quot;Tgamma0&quot;</span><span class="p">,</span> <span class="mf">2.725</span><span class="p">)</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">param_set_by_name</span><span class="p">(</span><span class="s2">&quot;massnu_0&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">param_set_by_name</span><span class="p">(</span><span class="s2">&quot;H0&quot;</span><span class="p">,</span> <span class="mf">70.0</span><span class="p">)</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">param_set_by_name</span><span class="p">(</span><span class="s2">&quot;Omegab&quot;</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">)</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">param_set_by_name</span><span class="p">(</span><span class="s2">&quot;Omegac&quot;</span><span class="p">,</span> <span class="mf">0.26</span><span class="p">)</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">param_set_by_name</span><span class="p">(</span><span class="s2">&quot;Omegak&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>


<span class="c1"># ENnu = 3.046 - 3.0 * \</span>
<span class="c1">#     cosmo_nc.E2Press_mnu(1.0e10) / (cosmo_nc.E2Omega_g(1.0e10)</span>
<span class="c1">#                                  * (7.0/8.0*(4.0/11.0)**(4.0/3.0)))</span>

<span class="n">ENnu</span> <span class="o">=</span> <span class="mf">3.046</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">param_set_by_name</span><span class="p">(</span><span class="s2">&quot;ENnu&quot;</span><span class="p">,</span> <span class="n">ENnu</span><span class="p">)</span>
<span class="n">reion</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">HIReionCamb</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">prim</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">HIPrimPowerLaw</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>

<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">add_submodel</span><span class="p">(</span><span class="n">reion</span><span class="p">)</span>
<span class="n">cosmo_nc</span><span class="o">.</span><span class="n">add_submodel</span><span class="p">(</span><span class="n">prim</span><span class="p">)</span>

<span class="n">dist</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">Distance</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
<span class="n">dist</span><span class="o">.</span><span class="n">prepare_if_needed</span><span class="p">(</span><span class="n">cosmo_nc</span><span class="p">)</span>
<span class="n">tf</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">TransferFunc</span><span class="o">.</span><span class="n">new_from_name</span><span class="p">(</span><span class="s2">&quot;NcTransferFuncEH&quot;</span><span class="p">)</span>

<span class="n">psml</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">PowspecMLTransfer</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>
<span class="n">psml</span><span class="o">.</span><span class="n">require_kmin</span><span class="p">(</span><span class="mf">1.0e-6</span><span class="p">)</span>
<span class="n">psml</span><span class="o">.</span><span class="n">require_kmax</span><span class="p">(</span><span class="mf">1.0e3</span><span class="p">)</span>

<span class="n">psf</span> <span class="o">=</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">PowspecFilter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">psml</span><span class="p">,</span> <span class="n">Ncm</span><span class="o">.</span><span class="n">PowspecFilterType</span><span class="o">.</span><span class="n">TOPHAT</span><span class="p">)</span>
<span class="n">psf</span><span class="o">.</span><span class="n">set_best_lnr0</span><span class="p">()</span>

<span class="n">prim</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">n_SA</span> <span class="o">=</span> <span class="mf">0.96</span>

<span class="n">old_amplitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">prim</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">ln10e10ASA</span><span class="p">)</span>
<span class="n">prim</span><span class="o">.</span><span class="n">props</span><span class="o">.</span><span class="n">ln10e10ASA</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mf">0.8</span> <span class="o">/</span> <span class="n">cosmo_nc</span><span class="o">.</span><span class="n">sigma8</span><span class="p">(</span><span class="n">psf</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">old_amplitude</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">cosmo_nc</span><span class="o">.</span><span class="n">sigma8</span><span class="p">(</span><span class="n">psf</span><span class="p">))</span>

<span class="n">mulf</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">MultiplicityFuncTinker</span><span class="o">.</span><span class="n">new</span><span class="p">()</span>
<span class="n">mulf</span><span class="o">.</span><span class="n">set_mdef</span><span class="p">(</span><span class="n">Nc</span><span class="o">.</span><span class="n">MultiplicityFuncMassDef</span><span class="o">.</span><span class="n">CRITICAL</span><span class="p">)</span>
<span class="n">mulf</span><span class="o">.</span><span class="n">set_Delta</span><span class="p">(</span><span class="mf">200.0</span><span class="p">)</span>
<span class="n">mf</span> <span class="o">=</span> <span class="n">Nc</span><span class="o">.</span><span class="n">HaloMassFunction</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">psf</span><span class="p">,</span> <span class="n">mulf</span><span class="p">)</span>


<span class="c1">#</span>
<span class="c1"># New mass function object using the objects defined above.</span>
<span class="c1">#</span>
<span class="k">def</span> <span class="nf">tinker08_nc</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="n">lnm</span> <span class="o">=</span> <span class="n">logm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>  <span class="c1"># convert log10(M) to ln(M)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">dn_dlnM</span><span class="p">(</span><span class="n">cosmo_nc</span><span class="p">,</span> <span class="n">lnm</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">res</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>  <span class="c1"># convert dn/dlnM to dn/dlog10M</span>


<span class="k">def</span> <span class="nf">pdf_tinker08_nc</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tinker08_nc</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">mf</span><span class="o">.</span><span class="n">dv_dzdomega</span><span class="p">(</span><span class="n">cosmo_nc</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="mf">0.8</span> <span class="mf">0.8</span>
</pre></div>
</div>
</section>
<section id="sanity-checks-compare-the-ccl-and-nc-implementations">
<h3>Sanity Checks - compare the CCL and NC implementations<a class="headerlink" href="#sanity-checks-compare-the-ccl-and-nc-implementations" title="Link to this heading"></a></h3>
<section id="volume-element">
<h4>Volume element<a class="headerlink" href="#volume-element" title="Link to this heading"></a></h4>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">v_nc</span> <span class="o">=</span> <span class="p">[</span><span class="n">mf</span><span class="o">.</span><span class="n">dv_dzdomega</span><span class="p">(</span><span class="n">cosmo_nc</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_arr</span><span class="p">]</span>
<span class="n">v_ccl</span> <span class="o">=</span> <span class="n">dV_over_dOmega_dz</span><span class="p">(</span><span class="n">z_arr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z_arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v_nc</span> <span class="o">/</span> <span class="n">v_ccl</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Redshift&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Relative difference [%]&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/demo_mock_ensemble_realistic_13_0.png" src="../_images/demo_mock_ensemble_realistic_13_0.png" />
</section>
<section id="mass-function">
<h4>Mass function<a class="headerlink" href="#mass-function" title="Link to this heading"></a></h4>
<p>The CCL and Numcosmo implementations give different results for the
Tinker08 HMF, especially at high redshift (&gt;1.5). Need to understand
why, although it is not a regime we should find ourselves in with
cluster studies at optical wavelength. Might be that the CCL and NC
cosmologies defined above are not actually the same (neutrinos?).</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">logm_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">14.0</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
<span class="n">z_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">t08_vec_ccl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">tinker08_ccl</span><span class="p">)</span>
<span class="n">t08_vec_nc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">tinker08_nc</span><span class="p">)</span>
<span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_arr</span><span class="p">:</span>
    <span class="n">res_ccl</span> <span class="o">=</span> <span class="n">t08_vec_ccl</span><span class="p">(</span><span class="n">logm_arr</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">res_nc</span> <span class="o">=</span> <span class="n">t08_vec_nc</span><span class="p">(</span><span class="n">logm_arr</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logm_arr</span><span class="p">,</span> <span class="n">res_ccl</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;z=</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">, CCL&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">logm_arr</span><span class="p">,</span> <span class="n">res_nc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;z=</span><span class="si">{</span><span class="n">z</span><span class="si">}</span><span class="s2">, NC&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;log10(M200,c)&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;dn/d$\log_</span><span class="si">{10}</span><span class="s2">$M&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/demo_mock_ensemble_realistic_15_0.png" src="../_images/demo_mock_ensemble_realistic_15_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">z_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">logm</span> <span class="o">=</span> <span class="mf">15.0</span>
<span class="n">res_ccl</span> <span class="o">=</span> <span class="n">t08_vec_ccl</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">z_arr</span><span class="p">)</span>
<span class="n">res_nc</span> <span class="o">=</span> <span class="n">t08_vec_nc</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">z_arr</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z_arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">res_ccl</span> <span class="o">/</span> <span class="n">res_nc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Redshift&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Relative difference [%]&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/demo_mock_ensemble_realistic_16_0.png" src="../_images/demo_mock_ensemble_realistic_16_0.png" />
</section>
</section>
<section id="acceptance-rejection-method-to-sample-m-z-from-the-mass-function">
<h3>Acceptance-rejection method to sample (M,z) from the mass function<a class="headerlink" href="#acceptance-rejection-method-to-sample-m-z-from-the-mass-function" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bivariate_draw</span><span class="p">(</span>
    <span class="n">pdf</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">logm_min</span><span class="o">=</span><span class="mf">14.0</span><span class="p">,</span> <span class="n">logm_max</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">zmin</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">Ngrid_m</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">Ngrid_z</span><span class="o">=</span><span class="mi">30</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Uses the rejection method for generating random numbers derived from an arbitrary</span>
<span class="sd">    probability distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    pdf : func</span>
<span class="sd">      2d distribution function to sample</span>
<span class="sd">    N : int</span>
<span class="sd">      number of points to generate</span>
<span class="sd">    log_min,logm_max : float</span>
<span class="sd">      log10 mass range</span>
<span class="sd">    zmin,zmax : float</span>
<span class="sd">      redshift range</span>

<span class="sd">    Returns:</span>
<span class="sd">    --------</span>
<span class="sd">    ran_logm : list</span>
<span class="sd">        accepted logm values</span>
<span class="sd">    ran_z : list</span>
<span class="sd">        accepted redshift values</span>
<span class="sd">    acceptance : float</span>
<span class="sd">        acceptance ratio of the method</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># maximum value of the pdf over the mass and redshift space.</span>
    <span class="c1"># the pdf is not monotonous in mass and redshift, so we need</span>
    <span class="c1"># to find the maximum numerically. Here we scan the space</span>
    <span class="c1"># with a regular grid and use the maximum value.</span>
    <span class="c1"># Accuracy of the results depends on Ngrid_m and Ngrid_z</span>
    <span class="c1"># This should probably be improved</span>

    <span class="n">logM_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">logm_min</span><span class="p">,</span> <span class="n">logm_max</span><span class="p">,</span> <span class="n">Ngrid_m</span><span class="p">)</span>
    <span class="n">z_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">zmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">zmax</span><span class="p">),</span> <span class="n">Ngrid_z</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">logM</span> <span class="ow">in</span> <span class="n">logM_arr</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="n">z_arr</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pdf</span><span class="p">(</span><span class="n">logM</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
    <span class="n">pmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">pmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="c1"># Counters</span>
    <span class="n">naccept</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ntrial</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Keeps drawing until N points are accepted</span>
    <span class="n">ran_logm</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># output list of random numbers</span>
    <span class="n">ran_z</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># output list of random numbers</span>
    <span class="k">while</span> <span class="n">naccept</span> <span class="o">&lt;</span> <span class="n">N</span><span class="p">:</span>
        <span class="c1"># draw (logm,z) from uniform distribution</span>
        <span class="c1"># draw p from uniform distribution</span>
        <span class="n">logm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">logm_min</span><span class="p">,</span> <span class="n">logm_max</span><span class="p">)</span>  <span class="c1"># x&#39;</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">)</span>  <span class="c1"># x&#39;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">pmax</span><span class="p">)</span>  <span class="c1"># y&#39;</span>

        <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">pdf</span><span class="p">(</span><span class="n">logm</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
            <span class="c1"># keep the point</span>
            <span class="c1">#            print(logm, z, p, pdf(logm, z))</span>
            <span class="n">ran_logm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">logm</span><span class="p">)</span>
            <span class="n">ran_z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="n">naccept</span> <span class="o">=</span> <span class="n">naccept</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">ntrial</span> <span class="o">=</span> <span class="n">ntrial</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">ran_logm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ran_logm</span><span class="p">)</span>
    <span class="n">ran_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">ran_z</span><span class="p">)</span>

    <span class="n">acceptance</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">N</span> <span class="o">/</span> <span class="n">ntrial</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;acceptance = </span><span class="si">{</span><span class="n">acceptance</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ran_logm</span><span class="p">,</span> <span class="n">ran_z</span><span class="p">,</span> <span class="n">acceptance</span>
</pre></div>
</div>
</section>
<section id="draw-10-4-m-z-pairs-and-check-consistency-with-mass-function">
<h3>Draw <span class="math notranslate nohighlight">\(10^4\)</span> (M,z) pairs and check consistency with mass function<a class="headerlink" href="#draw-10-4-m-z-pairs-and-check-consistency-with-mass-function" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the numbers of pairs to draw and the mass and redshift ranges</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">logm_min</span> <span class="o">=</span> <span class="mf">14.0</span>
<span class="n">logm_max</span> <span class="o">=</span> <span class="mf">14.5</span>
<span class="n">zmin</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">zmax</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Choose between the CCL and NC implementation (NC is faster)</span>
<span class="c1"># pdf = pdf_tinker08_ccl</span>
<span class="n">pdf</span> <span class="o">=</span> <span class="n">pdf_tinker08_nc</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Normalisation factor for the pdf to be used later</span>
<span class="n">norm</span> <span class="o">=</span> <span class="p">(</span>
    <span class="mf">1.0</span>
    <span class="o">/</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">dblquad</span><span class="p">(</span>
        <span class="n">pdf</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">logm_min</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">logm_max</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="mf">1.0e-4</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Random draw</span>
<span class="n">ran_logm</span><span class="p">,</span> <span class="n">ran_z</span><span class="p">,</span> <span class="n">acceptance</span> <span class="o">=</span> <span class="n">bivariate_draw</span><span class="p">(</span>
    <span class="n">pdf</span><span class="p">,</span> <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">logm_min</span><span class="o">=</span><span class="n">logm_min</span><span class="p">,</span> <span class="n">logm_max</span><span class="o">=</span><span class="n">logm_max</span><span class="p">,</span> <span class="n">zmin</span><span class="o">=</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="o">=</span><span class="n">zmax</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">acceptance</span> <span class="o">=</span> <span class="mf">0.32901230506020923</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">hist2d</span><span class="p">(</span><span class="n">ran_logm</span><span class="p">,</span> <span class="n">ran_z</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="k">pass</span>
</pre></div>
</div>
<img alt="../_images/demo_mock_ensemble_realistic_23_0.png" src="../_images/demo_mock_ensemble_realistic_23_0.png" />
</section>
<section id="check-distribution-in-mass-bins-integrate-over-the-full-redshift-range">
<h3>Check distribution in mass bins (integrate over the full redshift range)<a class="headerlink" href="#check-distribution-in-mass-bins-integrate-over-the-full-redshift-range" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist_m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">ran_logm</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">)</span>
<span class="n">predicted_T08_m_quad</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">norm</span>
    <span class="o">*</span> <span class="n">N</span>
    <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">dblquad</span><span class="p">(</span><span class="n">pdf</span><span class="p">,</span> <span class="n">zmin</span><span class="p">,</span> <span class="n">zmax</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">lmmin</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">lmmax</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="mf">1.0e-4</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">lmmin</span><span class="p">,</span> <span class="n">lmmax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hist_m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hist_m</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="mf">0.2</span> <span class="mf">1.0</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bin_centers_m</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">hist_m</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">hist_m</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">ran_logm</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="n">hist_m</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;teal&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;drawn masses - integrated over redshift range&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">bin_centers_m</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predicted_T08_m_quad</span><span class="p">),</span> <span class="s2">&quot;-o&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected from theory&quot;</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;$\log_</span><span class="si">{10}</span><span class="s2">$M&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">N</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> clusters drawn in log10M=</span><span class="si">{</span><span class="n">logm_min</span><span class="p">,</span><span class="w"> </span><span class="n">logm_max</span><span class="si">}</span><span class="s2">, z=</span><span class="si">{</span><span class="n">zmin</span><span class="p">,</span><span class="w"> </span><span class="n">zmax</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/demo_mock_ensemble_realistic_27_0.png" src="../_images/demo_mock_ensemble_realistic_27_0.png" />
</section>
<section id="check-distribution-in-redshift-bins-integrate-over-the-full-mass-range">
<h3>Check distribution in redshift bins (integrate over the full mass range)<a class="headerlink" href="#check-distribution-in-redshift-bins-integrate-over-the-full-mass-range" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hist_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">ran_z</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">logm_min</span><span class="p">,</span> <span class="n">logm_max</span><span class="p">)</span>
<span class="n">predicted_T08_z_quad</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">norm</span>
    <span class="o">*</span> <span class="n">N</span>
    <span class="o">*</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">dblquad</span><span class="p">(</span>
        <span class="n">pdf</span><span class="p">,</span> <span class="n">zzmin</span><span class="p">,</span> <span class="n">zzmax</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">logm_min</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">logm_max</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="mf">1.0e-4</span>
    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">zzmin</span><span class="p">,</span> <span class="n">zzmax</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">hist_z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hist_z</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="mf">14.0</span> <span class="mf">14.5</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">bin_centers_z</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">hist_z</span><span class="p">[</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">hist_z</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
    <span class="n">ran_z</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="n">hist_z</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;drawn redshift - integrated over mass range&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">bin_centers_z</span><span class="p">,</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">predicted_T08_z_quad</span><span class="p">),</span>
    <span class="s2">&quot;-o&quot;</span><span class="p">,</span>
    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Expected from theory&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Redshift&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Number&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">N</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> clusters drawn in log10M=</span><span class="si">{</span><span class="n">logm_min</span><span class="p">,</span><span class="w"> </span><span class="n">logm_max</span><span class="si">}</span><span class="s2">, z=</span><span class="si">{</span><span class="n">zmin</span><span class="p">,</span><span class="w"> </span><span class="n">zmax</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/demo_mock_ensemble_realistic_30_0.png" src="../_images/demo_mock_ensemble_realistic_30_0.png" />
</section>
</section>
<section id="generating-a-cluster-catalog-and-associated-source-catalogs">
<h2>Generating a cluster catalog and associated source catalogs<a class="headerlink" href="#generating-a-cluster-catalog-and-associated-source-catalogs" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>First, set the cluster masses and redshifts given the generated mock
data. Only keep 30 clusters from N generated above to avoid memory
issues.</p></li>
<li><p>Then, instantiate a CCL concentration object to compute the
concentration for each cluster from a mass-concentration realtion
(Duffy et al. 2008). The actual concentration for each cluster is
drawn from a lognormal distribution around the mean value</p></li>
<li><p>Last, we randomly generate the cluster center coordinates over the
full sky (from 0 to 360 deg for ra and from -90 to 90 deg to dec)</p></li>
</ul>
<section id="cluster-ensemble-masses-redshifts-and-positions">
<h3>Cluster ensemble masses, redshifts and positions<a class="headerlink" href="#cluster-ensemble-masses-redshifts-and-positions" title="Link to this heading"></a></h3>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Randomly keep 30 (M,z) pairs from the 1000s generated abve.</span>
<span class="n">Nstack</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ran_logm</span><span class="p">),</span> <span class="n">Nstack</span><span class="p">)</span>
<span class="n">cluster_m</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">ran_logm</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
<span class="n">cluster_z</span> <span class="o">=</span> <span class="n">ran_z</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

<span class="c1"># Concentration CCL object to compute the theoretical concentration</span>
<span class="n">conc_obj</span> <span class="o">=</span> <span class="n">ccl</span><span class="o">.</span><span class="n">halos</span><span class="o">.</span><span class="n">ConcentrationDuffy08</span><span class="p">(</span><span class="n">mass_def</span><span class="o">=</span><span class="n">hmd_200c</span><span class="p">)</span>
<span class="n">conc_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_m</span><span class="p">)):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">cluster_z</span><span class="p">[</span><span class="n">number</span><span class="p">]))</span>
    <span class="c1"># mean value of the concentration for that cluster</span>
    <span class="n">lnc_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">conc_obj</span><span class="p">(</span><span class="n">cosmo</span><span class="p">,</span> <span class="n">M</span><span class="o">=</span><span class="p">(</span><span class="n">cluster_m</span><span class="p">[</span><span class="n">number</span><span class="p">]),</span> <span class="n">a</span><span class="o">=</span><span class="n">a</span><span class="p">))</span>
    <span class="c1"># random draw of actual concentration from normal distribution around lnc_mean, with a 0.14 scatter</span>
    <span class="n">lnc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">lnc_mean</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">)</span>
    <span class="n">conc_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">lnc</span><span class="p">))</span>

<span class="n">conc_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">conc_list</span><span class="p">)</span>

<span class="c1"># randomly draw cluster positions over the full sky</span>
<span class="n">ra</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="mi">360</span>  <span class="c1"># from 0 to 360 deg</span>
<span class="n">sindec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">sindec</span><span class="p">)</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># from -90 to 90 deg</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">cluster_m</span><span class="p">)</span>
<span class="n">Nstack</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="mi">30</span>
</pre></div>
</div>
</section>
<section id="background-galaxy-catalog-generation">
<h3>Background galaxy catalog generation<a class="headerlink" href="#background-galaxy-catalog-generation" title="Link to this heading"></a></h3>
<p>For each cluster of the ensemble, we use <code class="docutils literal notranslate"><span class="pre">mock_data</span></code> to generate a
background galaxy catalog and store the results in a <code class="docutils literal notranslate"><span class="pre">GalaxyCluster</span></code>
object. Note that: - The cluster density profiles follow the NFW
parametrisation - The source redshifts follow the Chang et
al. distribution and have associated pdfs - The shapes include shape
noise and shape measurement errors - Background galaxy catalogs are
independent, even if the clusters are close (i.e., no common galaxy
between two catalogs). - For each cluster we then compute - the
tangential and cross <span class="math notranslate nohighlight">\(\Delta\Sigma\)</span> for each background galaxy -
the weights <code class="docutils literal notranslate"><span class="pre">w_ls</span></code> to be used to compute the corresponding radial
profiles (see <code class="docutils literal notranslate"><span class="pre">demo_compute_deltasigma_weights.ipynb</span></code> notebook for
details)</p>
<p>The cluster objects are then stored in <code class="docutils literal notranslate"><span class="pre">gclist</span></code>.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span>
    <span class="s2">&quot;ignore&quot;</span>
<span class="p">)</span>  <span class="c1"># just to prevent warning print out when looping over the cluster ensemble below</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">gclist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="c1"># number of galaxies in each cluster field (alternatively, can use the galaxy density instead)</span>
<span class="n">n_gals</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="c1"># ngal_density = 10</span>
<span class="n">cosmo_clmm</span> <span class="o">=</span> <span class="n">Cosmology</span><span class="p">(</span><span class="n">H0</span><span class="o">=</span><span class="mf">71.0</span><span class="p">,</span> <span class="n">Omega_dm0</span><span class="o">=</span><span class="mf">0.265</span> <span class="o">-</span> <span class="mf">0.0448</span><span class="p">,</span> <span class="n">Omega_b0</span><span class="o">=</span><span class="mf">0.0448</span><span class="p">,</span> <span class="n">Omega_k0</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="c1"># cosmo_clmm.set_be_cosmo(cosmo)</span>
<span class="n">gal_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo_clmm</span><span class="p">,</span>
    <span class="n">zsrc</span><span class="o">=</span><span class="s2">&quot;chang13&quot;</span><span class="p">,</span>
    <span class="n">delta_so</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">massdef</span><span class="o">=</span><span class="s2">&quot;critical&quot;</span><span class="p">,</span>
    <span class="n">halo_profile_model</span><span class="o">=</span><span class="s2">&quot;nfw&quot;</span><span class="p">,</span>
    <span class="n">zsrc_max</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
    <span class="n">field_size</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
    <span class="n">shapenoise</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
    <span class="n">photoz_sigma_unscaled</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
    <span class="n">ngals</span><span class="o">=</span><span class="n">n_gals</span><span class="p">,</span>
    <span class="n">mean_e_err</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nstack</span><span class="p">):</span>
    <span class="c1"># generate background galaxy catalog for cluster i</span>
    <span class="n">cl</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">GalaxyCluster</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;mock_cluster_</span><span class="si">{</span><span class="n">i</span><span class="si">:</span><span class="s2">04</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">ra</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">dec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">cluster_z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
        <span class="n">galcat</span><span class="o">=</span><span class="n">mock</span><span class="o">.</span><span class="n">generate_galaxy_catalog</span><span class="p">(</span>
            <span class="n">cluster_m</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">cluster_z</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">conc_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">cluster_ra</span><span class="o">=</span><span class="n">ra</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">cluster_dec</span><span class="o">=</span><span class="n">dec</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
            <span class="n">zsrc_min</span><span class="o">=</span><span class="n">cluster_z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="o">**</span><span class="n">gal_args</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="c1"># compute DeltaSigma for each background galaxy</span>
    <span class="n">cl</span><span class="o">.</span><span class="n">compute_tangential_and_cross_components</span><span class="p">(</span>
        <span class="n">shape_component1</span><span class="o">=</span><span class="s2">&quot;e1&quot;</span><span class="p">,</span>
        <span class="n">shape_component2</span><span class="o">=</span><span class="s2">&quot;e2&quot;</span><span class="p">,</span>
        <span class="n">tan_component</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span>
        <span class="n">cross_component</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">,</span>
        <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo_clmm</span><span class="p">,</span>
        <span class="n">is_deltasigma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_pdz</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># compute the weights to be used to bluid the DeltaSigma radial profiles</span>
    <span class="n">cl</span><span class="o">.</span><span class="n">compute_galaxy_weights</span><span class="p">(</span>
        <span class="n">use_pdz</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">use_shape_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">shape_component1</span><span class="o">=</span><span class="s2">&quot;e1&quot;</span><span class="p">,</span>
        <span class="n">shape_component2</span><span class="o">=</span><span class="s2">&quot;e2&quot;</span><span class="p">,</span>
        <span class="n">use_shape_error</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">shape_component1_err</span><span class="o">=</span><span class="s2">&quot;e_err&quot;</span><span class="p">,</span>
        <span class="n">shape_component2_err</span><span class="o">=</span><span class="s2">&quot;e_err&quot;</span><span class="p">,</span>
        <span class="n">weight_name</span><span class="o">=</span><span class="s2">&quot;w_ls&quot;</span><span class="p">,</span>
        <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo_clmm</span><span class="p">,</span>
        <span class="n">is_deltasigma</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># append the cluster in the list</span>
    <span class="n">gclist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mf">1.68</span> <span class="n">s</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mi">280</span> <span class="n">ms</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mf">1.96</span> <span class="n">s</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mf">1.96</span> <span class="n">s</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span><span class="o">.</span><span class="n">galcat</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">TableColumns</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span><span class="s1">&#39;e1&#39;</span><span class="p">,</span><span class="s1">&#39;e2&#39;</span><span class="p">,</span><span class="s1">&#39;e_err&#39;</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="s1">&#39;ztrue&#39;</span><span class="p">,</span><span class="s1">&#39;pzpdf&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;sigma_c_eff&#39;</span><span class="p">,</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span><span class="s1">&#39;DS_t&#39;</span><span class="p">,</span><span class="s1">&#39;DS_x&#39;</span><span class="p">,</span><span class="s1">&#39;w_ls&#39;</span><span class="p">)</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="creating-clusterensemble-object-and-estimation-of-individual-excess-surface-density-profiles">
<h2>Creating ClusterEnsemble object and estimation of individual excess surface density profiles<a class="headerlink" href="#creating-clusterensemble-object-and-estimation-of-individual-excess-surface-density-profiles" title="Link to this heading"></a></h2>
<p>From the galaxy cluster object list <code class="docutils literal notranslate"><span class="pre">gclist</span></code>, we instantiate a cluster
ensemble object <code class="docutils literal notranslate"><span class="pre">clusterensemble</span></code>. This instantiation step uses - the
individual galaxy input <span class="math notranslate nohighlight">\(\Delta\Sigma_+\)</span> and
<span class="math notranslate nohighlight">\(\Delta\Sigma_{\times}\)</span> values (computed in the previous step,
<code class="docutils literal notranslate"><span class="pre">DS_{t,x}</span></code>) - the corresponding individual input weights <code class="docutils literal notranslate"><span class="pre">w_ls</span></code>
(computed in the previous step)</p>
<p>to compute</p>
<ul class="simple">
<li><p>the output tangential <code class="docutils literal notranslate"><span class="pre">DS_t</span></code> and cross signal <code class="docutils literal notranslate"><span class="pre">DS_x</span></code> binned
profiles (where the binning is controlled by <code class="docutils literal notranslate"><span class="pre">bins</span></code>)</p></li>
<li><p>the associated profile weights <code class="docutils literal notranslate"><span class="pre">W_l</span></code> (that will be used to compute
the stacked profile)</p></li>
</ul>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">ensemble_id</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">clusterensemble</span> <span class="o">=</span> <span class="n">ClusterEnsemble</span><span class="p">(</span>
    <span class="n">ensemble_id</span><span class="p">,</span>
    <span class="n">gclist</span><span class="p">,</span>
    <span class="n">tan_component_in</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span>
    <span class="n">cross_component_in</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">,</span>
    <span class="n">tan_component_out</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span>
    <span class="n">cross_component_out</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">,</span>
    <span class="n">weights_in</span><span class="o">=</span><span class="s2">&quot;w_ls&quot;</span><span class="p">,</span>
    <span class="n">weights_out</span><span class="o">=</span><span class="s2">&quot;W_l&quot;</span><span class="p">,</span>
    <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
    <span class="n">bin_units</span><span class="o">=</span><span class="s2">&quot;Mpc&quot;</span><span class="p">,</span>
    <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo_clmm</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python3 notranslate"><div class="highlight"><pre><span></span><span class="n">CPU</span> <span class="n">times</span><span class="p">:</span> <span class="n">user</span> <span class="mi">280</span> <span class="n">ms</span><span class="p">,</span> <span class="n">sys</span><span class="p">:</span> <span class="mi">0</span> <span class="n">ns</span><span class="p">,</span> <span class="n">total</span><span class="p">:</span> <span class="mi">280</span> <span class="n">ms</span>
<span class="n">Wall</span> <span class="n">time</span><span class="p">:</span> <span class="mi">280</span> <span class="n">ms</span>
</pre></div>
</div>
<p>There is also the option to create an <code class="docutils literal notranslate"><span class="pre">ClusterEnsemble</span></code> object without
the clusters list. Then, the user may compute the individual profile for
each wanted cluster and compute the radial profile once all the
indvidual profiles have been computed. This method may be reccomended if
there a large number of clusters to avoid excess of memory allocation,
since the user can generate each cluster separately, compute its
individual profile and then delete the cluster object.</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble_id2</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">empty_cluster_ensemble</span> <span class="o">=</span> <span class="n">ClusterEnsemble</span><span class="p">(</span><span class="n">ensemble_id2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">gclist</span><span class="p">:</span>
    <span class="n">empty_cluster_ensemble</span><span class="o">.</span><span class="n">make_individual_radial_profile</span><span class="p">(</span>
        <span class="n">galaxycluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span>
        <span class="n">tan_component_in</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span>
        <span class="n">cross_component_in</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">,</span>
        <span class="n">tan_component_out</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span>
        <span class="n">cross_component_out</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">,</span>
        <span class="n">weights_in</span><span class="o">=</span><span class="s2">&quot;w_ls&quot;</span><span class="p">,</span>
        <span class="n">weights_out</span><span class="o">=</span><span class="s2">&quot;W_l&quot;</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
        <span class="n">bin_units</span><span class="o">=</span><span class="s2">&quot;Mpc&quot;</span><span class="p">,</span>
        <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo_clmm</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>A third option is where all clusters already have the profile computed,
and we just add those to the <code class="docutils literal notranslate"><span class="pre">ClusterEnsemble</span></code> object:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># add profiles to gclist</span>
<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">gclist</span><span class="p">:</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">make_radial_profile</span><span class="p">(</span>
        <span class="n">tan_component_in</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span>
        <span class="n">cross_component_in</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">,</span>
        <span class="n">tan_component_out</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span>
        <span class="n">cross_component_out</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">,</span>
        <span class="n">weights_in</span><span class="o">=</span><span class="s2">&quot;w_ls&quot;</span><span class="p">,</span>
        <span class="n">weights_out</span><span class="o">=</span><span class="s2">&quot;W_l&quot;</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span>
        <span class="n">bin_units</span><span class="o">=</span><span class="s2">&quot;Mpc&quot;</span><span class="p">,</span>
        <span class="n">cosmo</span><span class="o">=</span><span class="n">cosmo_clmm</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ensemble_id3</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">empty_cluster_ensemble</span> <span class="o">=</span> <span class="n">ClusterEnsemble</span><span class="p">(</span><span class="n">ensemble_id3</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cluster</span> <span class="ow">in</span> <span class="n">gclist</span><span class="p">:</span>
    <span class="n">empty_cluster_ensemble</span><span class="o">.</span><span class="n">add_individual_radial_profile</span><span class="p">(</span>
        <span class="n">galaxycluster</span><span class="o">=</span><span class="n">cluster</span><span class="p">,</span>
        <span class="n">profile_table</span><span class="o">=</span><span class="n">cluster</span><span class="o">.</span><span class="n">profile</span><span class="p">,</span>
        <span class="n">tan_component</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span>
        <span class="n">cross_component</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;W_l&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<section id="stacked-profile-of-the-cluster-ensemble">
<h3>Stacked profile of the cluster ensemble<a class="headerlink" href="#stacked-profile-of-the-cluster-ensemble" title="Link to this heading"></a></h3>
<p>The stacked radial profile of the ensemble is then obtained as</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusterensemble</span><span class="o">.</span><span class="n">make_stacked_radial_profile</span><span class="p">(</span><span class="n">tan_component</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span> <span class="n">cross_component</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="covariance-bootstrap-sample-jackknife-of-the-stack-between-radial-bins">
<h3>Covariance (Bootstrap, sample, Jackknife) of the stack between radial bins<a class="headerlink" href="#covariance-bootstrap-sample-jackknife-of-the-stack-between-radial-bins" title="Link to this heading"></a></h3>
<p>Radial bins may be correlated and the <code class="docutils literal notranslate"><span class="pre">ClusterEnsemble</span></code> class provides
three methods to compute the covariance matrix of the stacked signal,
from the data: - The Sample covariance directly computes the covariance
between radial bins of the <code class="docutils literal notranslate"><span class="pre">N</span></code> individual cluster profiles of the
stack. - The Bootstrap approach is a resampling technique generating
<code class="docutils literal notranslate"><span class="pre">n_bootstrap</span></code> ensembles of <code class="docutils literal notranslate"><span class="pre">N</span></code> randomly drawn clusters from the
original ensemble, allowing for duplication. For each new ensemble, the
stacked profile is computed and the covariance computed over the
<code class="docutils literal notranslate"><span class="pre">n_bootstrap</span></code> stacks. - The Jackknife approach is another resampling
technique, that divides the sky in a given number of regions
<span class="math notranslate nohighlight">\(N_{\rm region}\)</span> and computes the covariance removing one region
(i.e the clusters of the ensemble in that region) at a time. The stack
is then computed using the remaining clusters and the covariance
computed over the <span class="math notranslate nohighlight">\(N_{\rm region}\)</span> number of stacks. The division
of the sky is done using the Healpix pixelisation scheme and is
controlled by the <code class="docutils literal notranslate"><span class="pre">n_side</span></code> parameter, with
<span class="math notranslate nohighlight">\(N_{\rm region}=12 N_{\rm side}^2\)</span>.</p>
<p>NB: Approaches exist to compute the theoretical covariance of a stack
but these are not (yet) available in <code class="docutils literal notranslate"><span class="pre">CLMM</span></code></p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusterensemble</span><span class="o">.</span><span class="n">compute_sample_covariance</span><span class="p">(</span><span class="n">tan_component</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span> <span class="n">cross_component</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">)</span>
<span class="n">clusterensemble</span><span class="o">.</span><span class="n">compute_bootstrap_covariance</span><span class="p">(</span>
    <span class="n">tan_component</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span> <span class="n">cross_component</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span><span class="p">,</span> <span class="n">n_bootstrap</span><span class="o">=</span><span class="mi">300</span>
<span class="p">)</span>
<span class="n">clusterensemble</span><span class="o">.</span><span class="n">compute_jackknife_covariance</span><span class="p">(</span>
    <span class="n">n_side</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">tan_component</span><span class="o">=</span><span class="s2">&quot;DS_t&quot;</span><span class="p">,</span> <span class="n">cross_component</span><span class="o">=</span><span class="s2">&quot;DS_x&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">clusterensemble</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="s2">&quot;tan_sc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="mf">1e13</span><span class="p">,</span>
    <span class="s2">&quot;--&quot;</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;royalblue&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Sample&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">clusterensemble</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="s2">&quot;tan_jk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="mf">1e13</span><span class="p">,</span>
    <span class="s2">&quot;-s&quot;</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Bootstrap&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">clusterensemble</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="s2">&quot;tan_sc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="mf">1e13</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Jackknife&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;R [Mpc]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\sigma_{\Delta\Sigma}\ (\times 10^</span><span class="si">{13}</span><span class="s2"> M_\odot /Mpc^2)$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/demo_mock_ensemble_realistic_50_0.png" src="../_images/demo_mock_ensemble_realistic_50_0.png" />
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">maximum</span> <span class="o">=</span> <span class="n">clusterensemble</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="s2">&quot;tan_sc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
    <span class="n">axes</span><span class="p">,</span>
    <span class="p">[</span><span class="n">clusterensemble</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="s2">&quot;tan_sc&quot;</span><span class="p">],</span> <span class="n">clusterensemble</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="s2">&quot;tan_jk&quot;</span><span class="p">],</span> <span class="n">clusterensemble</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="s2">&quot;tan_sc&quot;</span><span class="p">]],</span>
    <span class="p">[</span><span class="s2">&quot;Stack : Sample&quot;</span><span class="p">,</span> <span class="s2">&quot;Stack : Bootstrap&quot;</span><span class="p">,</span> <span class="s2">&quot;Stack : Jackknife&quot;</span><span class="p">],</span>
<span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;radial bin index&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;radial bin index&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;Reds&quot;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maximum</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre></div>
</div>
<img alt="../_images/demo_mock_ensemble_realistic_51_0.png" src="../_images/demo_mock_ensemble_realistic_51_0.png" />
</section>
<section id="visualizing-the-stacked-profiles-and-corresponding-model">
<h3>Visualizing the stacked profiles and corresponding model<a class="headerlink" href="#visualizing-the-stacked-profiles-and-corresponding-model" title="Link to this heading"></a></h3>
<p>In the figure below, we plot: - the individual <span class="math notranslate nohighlight">\(\Delta\Sigma\)</span>
profiles of the clusters (light blue) - the stacked signal (red symbols)
- the prediction computed using a NFW profile and the mean values of the
mass, concentration and redshift in the stack (dashed black)</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">moo</span> <span class="o">=</span> <span class="n">clmm</span><span class="o">.</span><span class="n">Modeling</span><span class="p">(</span><span class="n">massdef</span><span class="o">=</span><span class="s2">&quot;critical&quot;</span><span class="p">,</span> <span class="n">delta_mdef</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">halo_profile_model</span><span class="o">=</span><span class="s2">&quot;nfw&quot;</span><span class="p">)</span>
<span class="n">moo</span><span class="o">.</span><span class="n">set_cosmo</span><span class="p">(</span><span class="n">cosmo_clmm</span><span class="p">)</span>
<span class="c1"># Average values of mass and concentration of the ensemble to be used below</span>
<span class="c1"># to overplot the model on the stacked profile</span>
<span class="n">moo</span><span class="o">.</span><span class="n">set_concentration</span><span class="p">(</span><span class="n">conc_list</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">moo</span><span class="o">.</span><span class="n">set_mass</span><span class="p">(</span><span class="n">cluster_m</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r_stack</span><span class="p">,</span> <span class="n">gt_stack</span><span class="p">,</span> <span class="n">gx_stack</span> <span class="o">=</span> <span class="p">(</span><span class="n">clusterensemble</span><span class="o">.</span><span class="n">stacked_data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span> <span class="s2">&quot;DS_t&quot;</span><span class="p">,</span> <span class="s2">&quot;DS_x&quot;</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.linewidth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">err_gt</span> <span class="o">=</span> <span class="n">clusterensemble</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="s2">&quot;tan_sc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="mf">1e13</span>
<span class="n">err_gx</span> <span class="o">=</span> <span class="n">clusterensemble</span><span class="o">.</span><span class="n">cov</span><span class="p">[</span><span class="s2">&quot;cross_sc&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span> <span class="o">**</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="mf">1e13</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">r_stack</span><span class="p">,</span>
    <span class="n">gt_stack</span> <span class="o">/</span> <span class="mf">1e13</span><span class="p">,</span>
    <span class="n">err_gt</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
    <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">elinewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stack&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
    <span class="n">r_stack</span><span class="p">,</span>
    <span class="n">gx_stack</span> <span class="o">/</span> <span class="mf">1e13</span><span class="p">,</span>
    <span class="n">err_gx</span><span class="p">,</span>
    <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span>
    <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
    <span class="n">capsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">elinewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">zorder</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Stack&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># print(moo.eval_excess_surface_density(clusterensemble.data[&#39;radius&#39;][0], cluster_z.mean())/1e13)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">moo</span><span class="o">.</span><span class="n">eval_excess_surface_density</span><span class="p">(</span><span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cluster_z</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="mf">1e13</span><span class="p">,</span>
    <span class="s2">&quot;--k&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Prediction from stack mean cluster&quot;</span><span class="p">,</span>
    <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
    <span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
    <span class="mi">0</span> <span class="o">*</span> <span class="n">moo</span><span class="o">.</span><span class="n">eval_excess_surface_density</span><span class="p">(</span><span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cluster_z</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="mf">1e13</span><span class="p">,</span>
    <span class="s2">&quot;--k&quot;</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;y=0&quot;</span><span class="p">,</span>
    <span class="n">zorder</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>


<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nstack</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
        <span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DS_t&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e13</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Individual&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;radius&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
        <span class="n">clusterensemble</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;DS_x&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e13</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;cyan&quot;</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Individual&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="c1"># axs[0].plot(np.average(clusterensemble.data[&#39;radius&#39;], axis = 0), np.average(clusterensemble.data[&#39;gt&#39;], weights = None, axis = 0)/1e13)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;R [Mpc]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;R [Mpc]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta\Sigma_+$ $[\times 10^</span><span class="si">{13}</span><span class="s2"> M_\odot /Mpc^])$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\Delta\Sigma_\times$  $[\times 10^</span><span class="si">{13}</span><span class="s2"> M_\odot /Mpc^2]$&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Tangential&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Cross&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="p">:</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s2">&quot;minor&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<img alt="../_images/demo_mock_ensemble_realistic_54_0.png" src="../_images/demo_mock_ensemble_realistic_54_0.png" />
</section>
</section>
<section id="saving-loading-clusterensemble">
<h2>Saving/Loading ClusterEnsemble<a class="headerlink" href="#saving-loading-clusterensemble" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">ClusterEnsemble</span></code> object also have an option for saving/loading:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusterensemble</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;ce.pkl&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusterensemble2</span> <span class="o">=</span> <span class="n">ClusterEnsemble</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;ce.pkl&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018-2021, LSST DESC CLMM Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>